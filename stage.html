<!DOCTYPE html>
<html>
<head>
   <meta charset="utf-8" />
   <title>OpenLP Lower3rd</title>
   <style>
      body {
         margin: 0;
      }

      body > div {
         position: absolute;
         margin: auto 0;
         width: 100%;
         min-height: 100px;
         font-family: Arial, Helvetica, sans-serif;
         font-weight: bold;
         text-align: center;
      }

      #text {
         color: white;
      }

      #text p{
         line-height: 1em;
         padding: 0;
         margin: 0;
      }
   </style>
</head>
<body>
   <div>
      <span id="text">
      </span>
   </div>

   <script type="text/javascript">
      window.OpenLP = {
         websocket_port: 4317,

         connect: function () {
            const host = window.location.hostname;
            ws = new WebSocket(`ws://${host}:${OpenLP.websocket_port}`);
            ws.onmessage = (event) => {
               const reader = new FileReader();
               reader.onload = () => {
                  data = JSON.parse(reader.result.toString()).results;

                  if (OpenLP.currentItem != data.item || OpenLP.currentService != data.service) {
                     OpenLP.currentItem = data.item;
                     OpenLP.currentService = data.service;
                     OpenLP.loadSlides();
                  }
                  else if (OpenLP.currentSlide != data.slide) {
                     OpenLP.currentSlide = parseInt(data.slide, 10);
                     OpenLP.updateSlide();
                  }
               };

               reader.readAsText(event.data);
            };
         },

         loadSlides: function () {
            fetch('/api/v2/controller/live-items?_=' + Date.now())
               .then(function (response) {
                  return response.json();
               })
               .then(function (data) {
                  OpenLP.currentSlides = data.slides;
                  OpenLP.currentSlide = 0;

                  OpenLP.currentSlides.forEach(function (slide, idx) {
                     if (slide["selected"])
                        OpenLP.currentSlide = idx;
                  });

                  OpenLP.updateSlide();
               });
         },

         updateSlide: function () {
            let content = '';
            let lines = OpenLP.currentSlides[OpenLP.currentSlide].text.split("\n");

            lines.forEach(function (line, idx) {
               content += '<p>' + line + '</p>';
            });

            document.getElementById('text').innerHTML = content;
         },

         alignToCenter: function () {
            document.getElementById('text').setAttribute('transform', 'translate(' + ((window.innerWidth / 2) + 7) + ')');
         }
      }

      window.onresize = OpenLP.alignToCenter;
      OpenLP.alignToCenter();
      OpenLP.connect();
   </script>
</body>
</html>